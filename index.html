<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#B22222">
<link rel="manifest" href="manifest.json">
<title>FieldForce Tecnico</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --font-size: 16px;
  --c1: #B22222;
  --c2: #8B0000;
  --c3: #CD5C5C;
  --ok: #10B981;
  --warn: #F59E0B;
  --err: #EF4444;
  --gray: #6B7280;
  --light: #F3F4F6;
  --dark: #1F2937;
  --white: #FFFFFF;
  --hh: 56px;
  --nh: 72px;
  --rad: 16px;
}
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { font-size: var(--font-size); }
body { font-family: var(--font); background: var(--light); color: var(--dark); min-height: 100vh; line-height: 1.5; }

/* LOGIN */
.login { position: fixed; inset: 0; background: linear-gradient(135deg, var(--c2), var(--c1), var(--c3)); display: flex; justify-content: center; align-items: center; padding: 24px; z-index: 2000; }
.login.hidden { display: none; }
.login-box { background: var(--white); padding: 40px 32px; border-radius: 24px; width: 100%; max-width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
.login-box h1 { font-size: 1.75rem; color: var(--c1); text-align: center; margin-bottom: 8px; }
.login-box .subtitle { color: var(--gray); text-align: center; margin-bottom: 32px; font-size: 0.875rem; }
.field { margin-bottom: 20px; }
.field label { display: block; font-size: 0.8125rem; font-weight: 600; margin-bottom: 8px; }
.field input, .field select, .field textarea { width: 100%; padding: 14px 16px; border: 2px solid #E5E7EB; border-radius: 12px; font-size: 1rem; font-family: var(--font); }
.field input:focus, .field select:focus, .field textarea:focus { border-color: var(--c1); outline: none; }
.btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; font-family: var(--font); }
.btn-primary { background: linear-gradient(135deg, var(--c1), var(--c2)); color: var(--white); }
.btn-ok { background: var(--ok); color: var(--white); }
.btn-err { background: var(--err); color: var(--white); }
.btn-outline { background: var(--white); border: 2px solid #E5E7EB; color: var(--dark); }
.btn:disabled { opacity: 0.6; }
.btn:active { transform: scale(0.98); }
.error { background: #FEE2E2; color: #991B1B; padding: 12px; border-radius: 10px; margin-bottom: 16px; font-size: 0.875rem; display: none; }
.error.show { display: block; }

/* HEADER */
.header { position: fixed; top: 0; left: 0; right: 0; height: var(--hh); background: linear-gradient(135deg, var(--c1), var(--c2)); color: var(--white); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 100; }
.header h1 { font-size: 1.125rem; display: flex; align-items: center; gap: 8px; }
.header-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: rgba(255,255,255,0.2); color: var(--white); font-size: 1.125rem; cursor: pointer; }
.avatar { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; }

/* MAIN */
.main { margin-top: var(--hh); margin-bottom: var(--nh); padding: 16px; min-height: calc(100vh - var(--hh) - var(--nh)); }
.section { display: none; }
.section.active { display: block; }

/* KPI */
.kpi-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
.kpi { background: var(--white); border-radius: var(--rad); padding: 16px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
.kpi .val { font-size: 2rem; font-weight: 700; color: var(--c1); }
.kpi .lbl { font-size: 0.75rem; color: var(--gray); margin-top: 4px; }
.kpi.ok .val { color: var(--ok); }
.kpi.warn .val { color: var(--warn); }

/* CARDS */
.sec-title { font-size: 1.125rem; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
.card { background: var(--white); border-radius: var(--rad); box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 14px; border-left: 4px solid var(--c1); overflow: hidden; cursor: pointer; }
.card:active { transform: scale(0.98); }
.card.urg { border-left-color: var(--err); background: linear-gradient(to right, #FEF2F2, var(--white)); }
.card.done { border-left-color: var(--ok); opacity: 0.7; }
.card.prog { border-left-color: var(--warn); }
.card-head { padding: 14px 16px; display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
.card-title { font-weight: 600; font-size: 0.9375rem; flex: 1; }
.badge { padding: 4px 10px; border-radius: 20px; font-size: 0.6875rem; font-weight: 600; }
.badge-ok { background: #D1FAE5; color: #065F46; }
.badge-warn { background: #FEF3C7; color: #92400E; }
.badge-err { background: #FEE2E2; color: #991B1B; }
.badge-blue { background: #DBEAFE; color: #1E40AF; }
.card-body { padding: 0 16px 14px; }
.card-row { display: flex; align-items: center; gap: 8px; font-size: 0.8125rem; color: var(--gray); margin-bottom: 6px; }
.card-row:last-child { margin-bottom: 0; }
.card-row .ic { width: 20px; text-align: center; }

/* EMPTY */
.empty { text-align: center; padding: 60px 20px; color: var(--gray); }
.empty .ic { font-size: 4rem; margin-bottom: 16px; }
.empty .t { font-size: 1.125rem; font-weight: 600; margin-bottom: 8px; }

/* MAP */
.section-map { position: fixed; top: var(--hh); left: 0; right: 0; bottom: var(--nh); padding: 0; }
.section-map #map { width: 100%; height: 100%; }
.map-ctrl { position: absolute; top: 16px; right: 16px; display: flex; flex-direction: column; gap: 8px; z-index: 1000; }
.map-btn { width: 44px; height: 44px; border-radius: 50%; border: none; background: var(--white); box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 1.25rem; cursor: pointer; }
.map-fab { position: absolute; bottom: 24px; right: 24px; width: 56px; height: 56px; border-radius: 50%; border: none; background: var(--c1); color: var(--white); font-size: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000; cursor: pointer; }
.map-info { position: absolute; bottom: 100px; left: 16px; right: 80px; background: var(--white); border-radius: 12px; padding: 12px 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; display: none; }
.map-info.show { display: block; }
.map-filters { position: absolute; top: 16px; left: 16px; background: var(--white); border-radius: 12px; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; display: none; }
.map-filters.show { display: block; }
.map-filters label { display: flex; align-items: center; gap: 8px; font-size: 0.8125rem; margin-bottom: 8px; cursor: pointer; }
.map-filters label:last-child { margin-bottom: 0; }
.marker-icon { background: var(--c1); border: 3px solid var(--white); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: var(--white); font-size: 0.875rem; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

/* BOTTOM NAV */
.nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nh); background: var(--white); display: flex; box-shadow: 0 -2px 20px rgba(0,0,0,0.1); z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
.nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border: none; background: none; color: var(--gray); font-size: 0.625rem; padding: 8px 4px; cursor: pointer; position: relative; font-family: var(--font); }
.nav-btn.active { color: var(--c1); }
.nav-btn .ic { width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.125rem; margin-bottom: 4px; }
.nav-btn.active .ic { background: var(--c1); color: var(--white); }
.nav-btn .lbl { font-weight: 500; }
.nav-btn.active .lbl { font-weight: 600; color: var(--c1); }
.nav-btn .cnt { position: absolute; top: 4px; right: calc(50% - 20px); min-width: 18px; height: 18px; background: var(--err); color: var(--white); border-radius: 9px; font-size: 0.625rem; font-weight: 700; display: flex; align-items: center; justify-content: center; }

/* PROFILE */
.profile-head { background: linear-gradient(135deg, var(--c1), var(--c2)); color: var(--white); padding: 32px 20px; text-align: center; margin: -16px -16px 20px; }
.profile-avatar { width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; margin: 0 auto 12px; }
.profile-name { font-size: 1.375rem; font-weight: 700; margin-bottom: 4px; }
.profile-role { font-size: 0.875rem; opacity: 0.8; }
.profile-card { background: var(--white); border-radius: var(--rad); box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 16px; overflow: hidden; }
.profile-card-head { padding: 16px; border-bottom: 1px solid #E5E7EB; font-weight: 600; font-size: 0.875rem; color: var(--c1); }
.profile-card-body { padding: 16px; }
.profile-row { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #F3F4F6; }
.profile-row:last-child { border-bottom: none; }
.profile-row .ic { font-size: 1.25rem; width: 24px; text-align: center; }
.profile-row .lbl { flex: 1; font-size: 0.875rem; }
.profile-row .val { font-size: 0.875rem; color: var(--gray); }

/* MODAL */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1500; display: flex; justify-content: center; align-items: flex-end; opacity: 0; visibility: hidden; transition: 0.3s; }
.modal.show { opacity: 1; visibility: visible; }
.modal-box { background: var(--white); width: 100%; max-width: 500px; max-height: 90vh; border-radius: 24px 24px 0 0; overflow: hidden; transform: translateY(100%); transition: 0.3s; }
.modal.show .modal-box { transform: translateY(0); }
.modal-head { padding: 20px; border-bottom: 1px solid #E5E7EB; display: flex; justify-content: space-between; align-items: center; position: relative; }
.modal-head::before { content: ''; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); width: 40px; height: 4px; background: #D1D5DB; border-radius: 2px; }
.modal-head h2 { font-size: 1.125rem; }
.modal-close { width: 36px; height: 36px; border: none; background: var(--light); border-radius: 50%; font-size: 1.25rem; cursor: pointer; }
.modal-body { padding: 20px; overflow-y: auto; max-height: calc(90vh - 140px); }
.modal-foot { padding: 16px 20px; border-top: 1px solid #E5E7EB; display: flex; gap: 12px; }
.modal-foot button { flex: 1; }

/* TOAST */
.toast { position: fixed; bottom: calc(var(--nh) + 16px); left: 50%; transform: translateX(-50%) translateY(100px); background: var(--dark); color: var(--white); padding: 14px 24px; border-radius: 12px; font-size: 0.875rem; font-weight: 500; z-index: 2000; opacity: 0; transition: 0.3s; }
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
.toast.ok { background: var(--ok); }
.toast.err { background: var(--err); }

.leaflet-routing-container { display: none; }
</style>
</head>
<body>

<div class="login" id="loginScreen">
<div class="login-box">
<h1>üîß <span id="brandName">FieldForce</span></h1>
<p class="subtitle" id="brandSlogan">App Tecnico</p>
<div id="loginLoad" style="text-align:center;color:var(--gray)">‚è≥ Caricamento...</div>
<form id="loginForm" style="display:none" onsubmit="return doLogin(event)">
<div class="error" id="loginErr"></div>
<div class="field"><label>Username</label><input type="text" id="inpUser" autocomplete="username" required></div>
<div class="field"><label>Password</label><input type="password" id="inpPwd" autocomplete="current-password" required></div>
<label style="display:flex;align-items:center;gap:8px;margin-bottom:24px;font-size:0.875rem;color:var(--gray);cursor:pointer"><input type="checkbox" id="inpRemember" checked style="width:18px;height:18px"> Ricordami</label>
<button type="submit" class="btn btn-primary" id="btnLogin">Accedi</button>
</form>
<p style="text-align:center;margin-top:24px;font-size:0.75rem;color:var(--gray)">Password dimenticata? Contatta l'amministratore.</p>
</div>
</div>

<header class="header" id="appHeader" style="display:none">
<h1 id="headerBrand">üîß FieldForce</h1>
<div style="display:flex;gap:8px;align-items:center">
<button class="header-btn" onclick="syncData()">üîÑ</button>
<div class="avatar" id="headerAvatar">T</div>
</div>
</header>

<main class="main" id="appMain" style="display:none">

<section class="section active" id="secHome">
<div class="kpi-grid">
<div class="kpi"><div class="val" id="kpiOggi">0</div><div class="lbl">Oggi</div></div>
<div class="kpi ok"><div class="val" id="kpiDone">0</div><div class="lbl">Completati</div></div>
<div class="kpi"><div class="val" id="kpiWeek">0</div><div class="lbl">Settimana</div></div>
<div class="kpi warn"><div class="val" id="kpiOre">0</div><div class="lbl">Ore</div></div>
</div>
<h2 class="sec-title">üìã Interventi Oggi</h2>
<div id="listaOggi"></div>
</section>

<section class="section" id="secWeek">
<h2 class="sec-title">üìÖ Prossimi 7 Giorni</h2>
<div id="listaWeek"></div>
</section>

<section class="section section-map" id="secMap">
<div id="map"></div>
<div class="map-ctrl">
<button class="map-btn" onclick="centerMe()" title="La mia posizione">üìç</button>
<button class="map-btn" onclick="fitAll()" title="Mostra tutti">üîç</button>
<button class="map-btn" onclick="toggleFilters()" title="Filtri">‚öôÔ∏è</button>
</div>
<div class="map-filters" id="mapFilters">
<label><input type="checkbox" id="fltOggi" checked onchange="updateMap()"> Solo oggi</label>
<label><input type="checkbox" id="fltUrg" onchange="updateMap()"> Solo urgenze</label>
<label><input type="checkbox" id="fltRoute" checked onchange="updateMap()"> Mostra percorso</label>
</div>
<div class="map-info" id="mapInfo"><strong id="mapInfoT">Percorso</strong><br><span id="mapInfoD" style="font-size:0.8125rem;color:var(--gray)">-</span></div>
<button class="map-fab" onclick="toggleMapList()" id="mapFab">üìã</button>
</section>

<section class="section" id="secUrg">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 class="sec-title" style="margin-bottom:0">üö® Urgenze</h2>
<button class="btn btn-err" style="width:auto;padding:10px 16px;font-size:0.8125rem" onclick="openNewUrg()">+ Segnala</button>
</div>
<div id="listaUrg"></div>
</section>

<section class="section" id="secProfile">
<div class="profile-head">
<div class="profile-avatar" id="profAvatar">T</div>
<div class="profile-name" id="profName">Nome Cognome</div>
<div class="profile-role" id="profRole">Ruolo</div>
</div>
<div class="profile-card">
<div class="profile-card-head">üì± Contatti</div>
<div class="profile-card-body">
<div class="profile-row"><span class="ic">üìß</span><span class="lbl">Email</span><span class="val" id="profEmail">-</span></div>
<div class="profile-row"><span class="ic">üìû</span><span class="lbl">Telefono</span><span class="val" id="profTel">-</span></div>
<div class="profile-row"><span class="ic">üìç</span><span class="lbl">Base</span><span class="val" id="profBase">-</span></div>
<div class="profile-row"><span class="ic">üë•</span><span class="lbl">Squadra</span><span class="val" id="profSquad">-</span></div>
</div>
</div>
<div class="profile-card">
<div class="profile-card-head">üìû Assistenza</div>
<div class="profile-card-body">
<div class="profile-row"><span class="ic">üìû</span><span class="lbl">Telefono</span><span class="val" id="assitTel">-</span></div>
<div class="profile-row"><span class="ic">üìß</span><span class="lbl">Email</span><span class="val" id="assitEmail">-</span></div>
<div class="profile-row"><span class="ic">üïê</span><span class="lbl">Orari</span><span class="val" id="assitOrari">-</span></div>
</div>
</div>
<button class="btn btn-outline" style="margin-bottom:16px" onclick="openChangePwd()">üîë Cambia Password</button>
<button class="btn btn-outline" onclick="logout()">üö™ Esci</button>
<p style="text-align:center;margin-top:20px;font-size:0.75rem;color:var(--gray)">FieldForce Tecnico v3.0</p>
</section>

</main>

<nav class="nav" id="appNav" style="display:none">
<button class="nav-btn active" onclick="showSec('secHome',this)"><span class="ic">üè†</span><span class="lbl">Home</span></button>
<button class="nav-btn" onclick="showSec('secWeek',this)"><span class="ic">üìÖ</span><span class="lbl">Settimana</span></button>
<button class="nav-btn" onclick="showSec('secMap',this)"><span class="ic">üó∫Ô∏è</span><span class="lbl">Mappa</span></button>
<button class="nav-btn" onclick="showSec('secUrg',this)" id="navUrg"><span class="ic">üö®</span><span class="lbl">Urgenze</span></button>
<button class="nav-btn" onclick="showSec('secProfile',this)"><span class="ic">üë§</span><span class="lbl">Profilo</span></button>
</nav>

<div class="modal" id="modInt">
<div class="modal-box">
<div class="modal-head"><h2>üìã Dettaglio Intervento</h2><button class="modal-close" onclick="closeMod('modInt')">‚úï</button></div>
<div class="modal-body" id="modIntBody"></div>
<div class="modal-foot" id="modIntFoot"></div>
</div>
</div>

<div class="modal" id="modUrg">
<div class="modal-box">
<div class="modal-head"><h2>üö® Segnala Urgenza</h2><button class="modal-close" onclick="closeMod('modUrg')">‚úï</button></div>
<div class="modal-body">
<div class="field"><label>Cliente</label><select id="urgCli" onchange="updUrgMac()"></select></div>
<div class="field"><label>Macchina</label><select id="urgMac"></select></div>
<div class="field"><label>Priorit√†</label><select id="urgPri"></select></div>
<div class="field"><label>Descrizione Problema</label><textarea id="urgProb" rows="4" placeholder="Descrivi il problema..."></textarea></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeMod('modUrg')">Annulla</button>
<button class="btn btn-err" onclick="sendUrg()">üö® Segnala</button>
</div>
</div>
</div>

<div class="modal" id="modPwd">
<div class="modal-box">
<div class="modal-head"><h2>üîë Cambia Password</h2><button class="modal-close" onclick="closeMod('modPwd')">‚úï</button></div>
<div class="modal-body">
<div class="field"><label>Nuova Password</label><input type="password" id="pwdNew" placeholder="Minimo 6 caratteri"></div>
<div class="field"><label>Conferma Password</label><input type="password" id="pwdConf" placeholder="Ripeti la password"></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeMod('modPwd')">Annulla</button>
<button class="btn btn-primary" onclick="changePwd()">üíæ Salva</button>
</div>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
// ========== CONFIGURAZIONE ==========
const API_URL = 'https://script.google.com/macros/s/AKfycbwWke2ScBtrV4cjdMsx1f-diEabp2v_rEUTuTBE5zKv4wfxcvXpTfiO5A3Q6q_lIJC8Kg/exec';
const API_TOKEN = 'MRS_FieldForce_2026_MBGOAT';

// ========== STATO ==========
let DATA = { config:{}, utenti:[], clienti:[], macchine:[], piano:[], urgenze:[], richieste:[], tipiIntervento:[], priorita:[], squadre:[] };
let USER = null;
let map = null, markers = [], routeLayer = null;

const $ = id => document.getElementById(id);
const today = () => new Date().toISOString().split('T')[0];
const fmtDate = d => d ? new Date(d).toLocaleDateString('it-IT', { weekday:'short', day:'numeric', month:'short' }) : '-';
const isTrue = v => v === true || v === 'TRUE' || v === 'true' || v === 1;

// ========== API ==========
async function api(action, data = {}, method = 'GET') {
  let url = API_URL, opts = {};
  if (method === 'GET') {
    url += '?' + new URLSearchParams({ action, token: API_TOKEN, userId: USER?.ID || '', ...data });
  } else {
    opts = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action, token: API_TOKEN, userId: USER?.ID || '', ...data }) };
  }
  const res = await fetch(url, opts);
  const r = await res.json();
  if (!r.success) throw new Error(r.error || 'Errore sconosciuto');
  return r.data;
}

// ========== INIT ==========
document.addEventListener('DOMContentLoaded', init);

async function init() {
  try {
    DATA = await api('getAll');
    applyConfig();
    $('loginLoad').style.display = 'none';
    $('loginForm').style.display = 'block';
    
    const saved = localStorage.getItem('ff_tecnico_session');
    if (saved) {
      const s = JSON.parse(saved);
      const u = DATA.utenti.find(x => x.ID === s.user?.ID);
      if (u) { USER = { ...s.user, ...u }; enterApp(); }
    }
  } catch (e) {
    $('loginLoad').innerHTML = '‚ùå Errore: ' + e.message + '<br><br><button onclick="location.reload()" class="btn btn-primary" style="width:auto;padding:12px 24px">Riprova</button>';
  }
}

function applyConfig() {
  const c = DATA.config;
  // Font
  if (c.font_famiglia) document.documentElement.style.setProperty('--font', c.font_famiglia);
  if (c.font_size_base) document.documentElement.style.setProperty('--font-size', c.font_size_base + 'px');
  // Colori
  if (c.colore_primario) document.documentElement.style.setProperty('--c1', c.colore_primario);
  if (c.colore_secondario) document.documentElement.style.setProperty('--c2', c.colore_secondario);
  if (c.colore_accent) document.documentElement.style.setProperty('--c3', c.colore_accent);
  if (c.colore_success) document.documentElement.style.setProperty('--ok', c.colore_success);
  if (c.colore_warning) document.documentElement.style.setProperty('--warn', c.colore_warning);
  if (c.colore_danger) document.documentElement.style.setProperty('--err', c.colore_danger);
  // Brand
  if (c.azienda_nome) { $('brandName').textContent = c.azienda_nome; $('headerBrand').textContent = 'üîß ' + c.azienda_nome; }
  if (c.azienda_slogan) $('brandSlogan').textContent = c.azienda_slogan;
  // Assistenza
  if (c.telefono_assistenza) $('assitTel').textContent = c.telefono_assistenza;
  if (c.email_assistenza) $('assitEmail').textContent = c.email_assistenza;
  if (c.orari_assistenza) $('assitOrari').textContent = c.orari_assistenza;
  // Theme
  if (c.colore_primario) document.querySelector('meta[name="theme-color"]')?.setAttribute('content', c.colore_primario);
}

// ========== LOGIN ==========
async function doLogin(e) {
  e.preventDefault();
  const user = $('inpUser').value.trim(), pwd = $('inpPwd').value, rem = $('inpRemember').checked;
  if (!user || !pwd) { showErr('Inserisci username e password'); return false; }
  $('btnLogin').disabled = true; $('btnLogin').textContent = 'Accesso in corso...';
  try {
    const r = await api('login', { username: user, password: pwd }, 'POST');
    if (r.success === false) { showErr(r.error || 'Credenziali non valide'); return false; }
    USER = r.user;
    if (rem) localStorage.setItem('ff_tecnico_session', JSON.stringify({ user: USER, time: Date.now() }));
    enterApp();
  } catch (e) { showErr(e.message); }
  finally { $('btnLogin').disabled = false; $('btnLogin').textContent = 'Accedi'; }
  return false;
}

function showErr(m) { const e = $('loginErr'); e.textContent = m; e.classList.add('show'); setTimeout(() => e.classList.remove('show'), 5000); }
function logout() { localStorage.removeItem('ff_tecnico_session'); location.reload(); }

// ========== ENTER APP ==========
function enterApp() {
  $('loginScreen').classList.add('hidden');
  $('appHeader').style.display = 'flex';
  $('appMain').style.display = 'block';
  $('appNav').style.display = 'flex';
  
  const ini = (USER.Nome?.[0] || '') + (USER.Cognome?.[0] || '');
  $('headerAvatar').textContent = ini;
  $('profAvatar').textContent = ini;
  $('profName').textContent = (USER.Nome || '') + ' ' + (USER.Cognome || '');
  $('profRole').textContent = USER.Ruolo || 'Tecnico';
  $('profEmail').textContent = USER.Email || '-';
  $('profTel').textContent = USER.Telefono || '-';
  $('profBase').textContent = USER.Base || '-';
  $('profSquad').textContent = USER.Squadra || '-';
  
  renderAll();
  setTimeout(initMap, 500);
}

// ========== SYNC ==========
async function syncData() {
  toast('üîÑ Sincronizzazione...', '');
  try { DATA = await api('getAll'); renderAll(); updateMap(); toast('‚úÖ Dati aggiornati!', 'ok'); }
  catch (e) { toast('‚ùå ' + e.message, 'err'); }
}

// ========== RENDER ==========
function renderAll() { renderHome(); renderWeek(); renderUrg(); updUrgBadge(); }

function getMiei() { return DATA.piano.filter(p => p.TecnicoID === USER.ID && !isTrue(p.Obsoleto)); }
function getCli(id) { return DATA.clienti.find(c => c.ID === id) || {}; }
function getMac(id) { return DATA.macchine.find(m => m.ID === id) || {}; }
function getTipo(id) { return DATA.tipiIntervento.find(t => t.ID === id) || {}; }
function getPri(id) { return DATA.priorita.find(p => p.ID === id) || {}; }

function renderHome() {
  const int = getMiei().filter(p => String(p.Data).split('T')[0] === today());
  const done = int.filter(p => p.Stato === 'completato').length;
  const ore = int.reduce((s, p) => s + (parseFloat(p.DurataOre) || 0), 0);
  $('kpiOggi').textContent = int.length;
  $('kpiDone').textContent = done;
  $('kpiOre').textContent = ore.toFixed(1);
  
  const now = new Date(), ws = new Date(now); ws.setDate(now.getDate() - now.getDay() + 1);
  const we = new Date(ws); we.setDate(ws.getDate() + 6);
  $('kpiWeek').textContent = getMiei().filter(p => { const d = new Date(p.Data); return d >= ws && d <= we; }).length;
  
  if (!int.length) { $('listaOggi').innerHTML = '<div class="empty"><div class="ic">‚òÄÔ∏è</div><div class="t">Nessun intervento oggi</div><p>Goditi la giornata!</p></div>'; return; }
  int.sort((a, b) => (a.OraInizio || '').localeCompare(b.OraInizio || ''));
  $('listaOggi').innerHTML = int.map(p => cardHTML(p)).join('');
}

function renderWeek() {
  const now = new Date(), end = new Date(); end.setDate(now.getDate() + 7);
  const int = getMiei().filter(p => { const d = new Date(p.Data); return d >= now && d <= end; }).sort((a, b) => new Date(a.Data) - new Date(b.Data));
  if (!int.length) { $('listaWeek').innerHTML = '<div class="empty"><div class="ic">üì≠</div><div class="t">Nessun intervento</div><p>Non hai interventi nei prossimi 7 giorni</p></div>'; return; }
  $('listaWeek').innerHTML = int.map(p => cardHTML(p)).join('');
}

function cardHTML(p) {
  const cli = getCli(p.ClienteID), mac = getMac(p.MacchinaID), tipo = getTipo(p.TipoInterventoID);
  const isUrg = (tipo.Nome || '').toLowerCase().includes('urgenza'), isDone = p.Stato === 'completato', isProg = p.Stato === 'in_corso';
  let bc = 'badge-blue', bt = 'Pianificato';
  if (isDone) { bc = 'badge-ok'; bt = 'Completato'; }
  else if (isProg) { bc = 'badge-warn'; bt = 'In corso'; }
  else if (isUrg) { bc = 'badge-err'; bt = 'Urgenza'; }
  return `<div class="card ${isUrg ? 'urg' : ''} ${isDone ? 'done' : ''} ${isProg ? 'prog' : ''}" onclick="openInt('${p.ID}')">
    <div class="card-head"><span class="card-title">${cli.Nome || 'Cliente'}</span><span class="badge ${bc}">${bt}</span></div>
    <div class="card-body">
      <div class="card-row"><span class="ic">üìÖ</span>${fmtDate(p.Data)} ${p.OraInizio ? '‚Ä¢ ' + p.OraInizio : ''}</div>
      <div class="card-row"><span class="ic">${tipo.Icona || 'üîß'}</span>${tipo.Nome || 'Intervento'} ${p.DurataOre ? '‚Ä¢ ' + p.DurataOre + 'h' : ''}</div>
      <div class="card-row"><span class="ic">‚öôÔ∏è</span>${mac.Tipo || '-'} ${mac.Seriale ? '‚Ä¢ ' + mac.Seriale : ''}</div>
      <div class="card-row"><span class="ic">üìç</span>${cli.Citta || '-'}, ${cli.Indirizzo || ''}</div>
      ${p.Note ? `<div class="card-row"><span class="ic">üìù</span>${p.Note}</div>` : ''}
    </div></div>`;
}

function renderUrg() {
  const urg = DATA.urgenze.filter(u => !isTrue(u.Obsoleto) && (u.TecnicoAssegnato === USER.ID || u.SegnalatoDa === USER.ID) && u.Stato !== 'risolta');
  if (!urg.length) { $('listaUrg').innerHTML = '<div class="empty"><div class="ic">‚úÖ</div><div class="t">Nessuna urgenza</div><p>Non hai urgenze assegnate</p></div>'; return; }
  $('listaUrg').innerHTML = urg.map(u => {
    const cli = getCli(u.ClienteID), pri = getPri(u.PrioritaID);
    return `<div class="card urg"><div class="card-head"><span class="card-title">${cli.Nome || 'Cliente'}</span><span class="badge badge-err">${pri.Nome || 'Urgenza'}</span></div>
      <div class="card-body"><div class="card-row"><span class="ic">üìÖ</span>${fmtDate(u.DataSegnalazione)}</div>
      <div class="card-row"><span class="ic">‚ö†Ô∏è</span>${u.Problema || '-'}</div>
      <div class="card-row"><span class="ic">üìä</span>Stato: ${u.Stato}</div></div></div>`;
  }).join('');
}

function updUrgBadge() {
  const cnt = DATA.urgenze.filter(u => !isTrue(u.Obsoleto) && u.TecnicoAssegnato === USER.ID && u.Stato !== 'risolta').length;
  let b = $('navUrg').querySelector('.cnt');
  if (cnt > 0) { if (!b) { b = document.createElement('span'); b.className = 'cnt'; $('navUrg').appendChild(b); } b.textContent = cnt; }
  else if (b) b.remove();
}

// ========== MAP ==========
function initMap() {
  if (map) return;
  const lat = parseFloat(DATA.config.mappa_lat) || 44.6471, lng = parseFloat(DATA.config.mappa_lng) || 10.9252, zoom = parseInt(DATA.config.mappa_zoom) || 10;
  map = L.map('map', { zoomControl: false }).setView([lat, lng], zoom);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
  L.control.zoom({ position: 'bottomleft' }).addTo(map);
  updateMap();
}

function updateMap() {
  if (!map) return;
  markers.forEach(m => map.removeLayer(m)); markers = [];
  if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
  
  const fltO = $('fltOggi')?.checked, fltU = $('fltUrg')?.checked, fltR = $('fltRoute')?.checked;
  let int = getMiei().filter(p => p.Stato !== 'completato');
  if (fltO) int = int.filter(p => String(p.Data).split('T')[0] === today());
  if (fltU) { const tu = DATA.tipiIntervento.find(t => (t.Nome || '').toLowerCase().includes('urgenza')); if (tu) int = int.filter(p => p.TipoInterventoID === tu.ID); }
  int.sort((a, b) => (a.OraInizio || '').localeCompare(b.OraInizio || ''));
  
  const waypoints = [];
  int.forEach((p, i) => {
    const cli = getCli(p.ClienteID); if (!cli.Lat || !cli.Lng) return;
    const tipo = getTipo(p.TipoInterventoID);
    const icon = L.divIcon({ className: '', html: `<div class="marker-icon" style="background:${tipo.Colore || '#B22222'}">${i + 1}</div>`, iconSize: [32, 32], iconAnchor: [16, 16] });
    const m = L.marker([cli.Lat, cli.Lng], { icon }).addTo(map);
    m.bindPopup(`<b>${cli.Nome}</b><br>${cli.Indirizzo || ''}, ${cli.Citta || ''}<br><br><a href="https://maps.google.com/?q=${cli.Lat},${cli.Lng}" target="_blank" style="color:#B22222">üìç Naviga</a> &nbsp; <a href="tel:${cli.Telefono}" style="color:#10B981">üìû Chiama</a>`);
    markers.push(m);
    waypoints.push([cli.Lat, cli.Lng]);
  });
  
  // Percorso semplice (linea)
  if (fltR && waypoints.length >= 2) {
    const userLat = USER.Lat || parseFloat(DATA.config.mappa_lat) || 44.6471;
    const userLng = USER.Lng || parseFloat(DATA.config.mappa_lng) || 10.9252;
    const allPoints = [[userLat, userLng], ...waypoints];
    routeLayer = L.polyline(allPoints, { color: '#B22222', weight: 4, opacity: 0.7, dashArray: '10, 10' }).addTo(map);
    $('mapInfo').classList.add('show');
    $('mapInfoT').textContent = int.length + ' interventi';
    $('mapInfoD').textContent = 'Percorso visualizzato';
  } else {
    $('mapInfo').classList.remove('show');
  }
}

function centerMe() {
  if (!navigator.geolocation) { toast('GPS non disponibile', 'warn'); return; }
  navigator.geolocation.getCurrentPosition(p => { map.setView([p.coords.latitude, p.coords.longitude], 14); }, () => toast('Posizione non disponibile', 'err'));
}
function fitAll() { if (markers.length) map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1)); }
function toggleFilters() { $('mapFilters').classList.toggle('show'); }
function toggleMapList() { toast('Lista interventi nella sezione Home', ''); }

// ========== MODAL INTERVENTO ==========
function openInt(id) {
  const p = DATA.piano.find(x => x.ID === id); if (!p) return;
  const cli = getCli(p.ClienteID), mac = getMac(p.MacchinaID), tipo = getTipo(p.TipoInterventoID);
  
  let h = `<div class="field"><label>Cliente</label><div style="padding:12px;background:var(--light);border-radius:10px">
    <b>${cli.Nome || '-'}</b><br><small>${cli.Indirizzo || ''}, ${cli.Citta || ''} ${cli.Prov || ''}</small>
    ${cli.Lat && cli.Lng ? `<br><a href="https://maps.google.com/?q=${cli.Lat},${cli.Lng}" target="_blank" style="color:var(--c1)">üìç Apri in Maps</a>` : ''}
    ${cli.Telefono ? ` &nbsp; <a href="tel:${cli.Telefono}" style="color:var(--ok)">üìû ${cli.Telefono}</a>` : ''}</div></div>
    <div class="field"><label>Macchina</label><div style="padding:12px;background:var(--light);border-radius:10px">${mac.Tipo || '-'} ‚Ä¢ ${mac.Modello || ''}<br><small>SN: ${mac.Seriale || '-'} | Ore: ${mac.OreLavoro || '-'}</small></div></div>
    <div class="field"><label>Intervento</label><div style="padding:12px;background:var(--light);border-radius:10px">${tipo.Icona || 'üîß'} ${tipo.Nome || '-'} ‚Ä¢ ${p.DurataOre || '-'}h<br><small>${fmtDate(p.Data)} ${p.OraInizio ? '‚Ä¢ ' + p.OraInizio : ''}</small></div></div>`;
  if (p.Note) h += `<div class="field"><label>Note Admin</label><div style="padding:12px;background:var(--light);border-radius:10px">${p.Note}</div></div>`;
  
  if (p.Stato !== 'completato') {
    h += `<div class="field"><label>Ore Macchina Attuali</label><input type="number" id="intOre" value="${mac.OreLavoro || ''}" placeholder="Es: 1250"></div>
          <div class="field"><label>Note Tecnico</label><textarea id="intNote" rows="3" placeholder="Descrivi il lavoro svolto...">${p.NoteTecnico || ''}</textarea></div>`;
  } else {
    h += `<div class="field"><label>Completato</label><div style="padding:12px;background:#D1FAE5;border-radius:10px;color:#065F46">‚úÖ ${p.OraInizio || '-'} ‚Üí ${p.OraFine || '-'}${p.NoteTecnico ? '<br><small>' + p.NoteTecnico + '</small>' : ''}</div></div>`;
  }
  
  $('modIntBody').innerHTML = h;
  
  let f = '';
  if (p.Stato === 'completato') f = '<button class="btn btn-outline" onclick="closeMod(\'modInt\')">Chiudi</button>';
  else if (p.Stato === 'in_corso') f = `<button class="btn btn-outline" onclick="closeMod('modInt')">Annulla</button><button class="btn btn-ok" onclick="completeInt('${p.ID}')">‚úÖ Completa</button>`;
  else f = `<button class="btn btn-outline" onclick="closeMod('modInt')">Annulla</button><button class="btn btn-primary" onclick="startInt('${p.ID}')">‚ñ∂Ô∏è Inizia</button>`;
  $('modIntFoot').innerHTML = f;
  
  openMod('modInt');
}

async function startInt(id) {
  try { await api('startPiano', { id }, 'POST'); toast('‚ñ∂Ô∏è Intervento iniziato!', 'ok'); closeMod('modInt'); await syncData(); }
  catch (e) { toast('‚ùå ' + e.message, 'err'); }
}

async function completeInt(id) {
  const p = DATA.piano.find(x => x.ID === id);
  const ore = $('intOre')?.value || '', note = $('intNote')?.value || '';
  try {
    await api('completePiano', { id, data: { OreMacchinaFine: ore, NoteTecnico: note, MacchinaID: p?.MacchinaID } }, 'POST');
    toast('‚úÖ Intervento completato!', 'ok'); closeMod('modInt'); await syncData();
  } catch (e) { toast('‚ùå ' + e.message, 'err'); }
}

// ========== URGENZE ==========
function openNewUrg() {
  $('urgCli').innerHTML = '<option value="">-- Seleziona cliente --</option>' + DATA.clienti.filter(c => !isTrue(c.Obsoleto)).map(c => `<option value="${c.ID}">${c.Nome}</option>`).join('');
  $('urgPri').innerHTML = DATA.priorita.filter(p => isTrue(p.Attivo)).sort((a, b) => (a.Ordine || 0) - (b.Ordine || 0)).map(p => `<option value="${p.ID}">${p.Nome}</option>`).join('');
  $('urgMac').innerHTML = '<option value="">-- Prima seleziona cliente --</option>';
  $('urgProb').value = '';
  openMod('modUrg');
}

function updUrgMac() {
  const cid = $('urgCli').value;
  const macs = DATA.macchine.filter(m => m.ClienteID === cid && !isTrue(m.Obsoleto));
  $('urgMac').innerHTML = '<option value="">-- Seleziona macchina --</option>' + macs.map(m => `<option value="${m.ID}">${m.Tipo} - ${m.Seriale}</option>`).join('');
}

async function sendUrg() {
  const cid = $('urgCli').value, mid = $('urgMac').value, pid = $('urgPri').value, prob = $('urgProb').value.trim();
  if (!cid || !mid || !prob) { toast('Compila tutti i campi obbligatori', 'warn'); return; }
  try {
    await api('createUrgenza', { data: { ClienteID: cid, MacchinaID: mid, PrioritaID: pid, Problema: prob, SegnalatoDa: USER.ID } }, 'POST');
    toast('üö® Urgenza segnalata!', 'ok'); closeMod('modUrg'); await syncData();
  } catch (e) { toast('‚ùå ' + e.message, 'err'); }
}

// ========== PASSWORD ==========
function openChangePwd() { $('pwdNew').value = ''; $('pwdConf').value = ''; openMod('modPwd'); }

async function changePwd() {
  const pwd = $('pwdNew').value, conf = $('pwdConf').value;
  if (!pwd || pwd.length < 6) { toast('Password troppo corta (min 6 caratteri)', 'warn'); return; }
  if (pwd !== conf) { toast('Le password non coincidono', 'warn'); return; }
  try {
    await api('changePassword', { userId: USER.ID, newPassword: pwd }, 'POST');
    toast('‚úÖ Password modificata!', 'ok'); closeMod('modPwd');
  } catch (e) { toast('‚ùå ' + e.message, 'err'); }
}

// ========== NAVIGAZIONE ==========
function showSec(id, btn) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  $(id).classList.add('active'); btn.classList.add('active');
  $('appMain').style.padding = id === 'secMap' ? '0' : '16px';
  if (id === 'secMap') setTimeout(() => { if (map) map.invalidateSize(); else initMap(); }, 100);
}

// ========== MODAL/TOAST ==========
function openMod(id) { $(id).classList.add('show'); }
function closeMod(id) { $(id).classList.remove('show'); }
document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if (e.target === m) closeMod(m.id); }));
function toast(msg, type = '') { const t = $('toast'); t.textContent = msg; t.className = 'toast show' + (type ? ' ' + type : ''); setTimeout(() => t.classList.remove('show'), 4000); }
</script>
</body>
</html>
